#!/bin/bash
# Copyright (c) Lawrence Livermore National Security, LLC
# SPDX-License-Identifier: (BSD-3-Clause)
#
# Run Smith contact models (auto-detects Docker or local)

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
USE_DOCKER="${USE_DOCKER:-auto}"
DOCKER_IMAGE="${DOCKER_IMAGE:-seracllnl/tpls:clang-19_latest}"
SMITH_INSTALL="$(pwd)/smith-install"
MODELS_DIR="$(pwd)/smith-models"

# All available models
ALL_MODELS=(
    "block-on-slab"
    "concentric-spheres"
    "deep-indentation"
    "die-on-slab"
    "hemisphere-twisting"
    "hollow-sphere-pinching"
    "sphere-in-sphere"
    "stacked-blocks"
)

# Usage information
usage() {
    echo "Usage: $0 [OPTIONS] [MODEL_NAME]"
    echo ""
    echo "Run Smith contact models"
    echo ""
    echo "Arguments:"
    echo "  MODEL_NAME              Name of specific model to run (optional)"
    echo ""
    echo "Options:"
    echo "  --all                   Run all models"
    echo "  --list                  List all available models"
    echo "  --docker                Force use of Docker"
    echo "  --local                 Force use of local build"
    echo "  --clean                 Clean all build directories before running"
    echo "  -h, --help              Show this help message"
    echo ""
    echo "Available models:"
    for model in "${ALL_MODELS[@]}"; do
        echo "  - $model"
    done
    echo ""
    echo "Examples:"
    echo "  $0 die-on-slab          # Run single model (auto-detect environment)"
    echo "  $0 --docker --all       # Run all models in Docker"
    echo "  $0 --local stacked-blocks  # Run locally"
    echo "  $0 --clean --all        # Clean and run all models"
    echo ""
}

# List models
list_models() {
    echo "Available models:"
    for model in "${ALL_MODELS[@]}"; do
        if [ -d "$MODELS_DIR/$model" ]; then
            echo -e "  ${GREEN}✓${NC} $model"
        else
            echo -e "  ${RED}✗${NC} $model (not found)"
        fi
    done
}

# Determine if we should use Docker
should_use_docker() {
    if [ "$USE_DOCKER" = "yes" ]; then
        return 0
    elif [ "$USE_DOCKER" = "no" ]; then
        return 1
    else
        # Auto-detect: use Docker if it's running and Smith isn't built locally
        if docker info > /dev/null 2>&1; then
            if [ ! -f "$SMITH_INSTALL/lib/cmake/smith-config.cmake" ]; then
                echo -e "${YELLOW}Note: Smith not found locally, will use Docker${NC}"
                return 0
            else
                echo -e "${YELLOW}Note: Using local Smith installation${NC}"
                return 1
            fi
        else
            echo -e "${YELLOW}Note: Docker not running, will use local build${NC}"
            return 1
        fi
    fi
}

# Run a single model with Docker
run_model_docker() {
    local model_name=$1
    local build_dir="build_${model_name}"
    local exec_name="${model_name//-/_}"

    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}Running model (Docker): $model_name${NC}"
    echo -e "${BLUE}========================================${NC}"

    # Create build directory with proper permissions
    mkdir -p "$build_dir"
    chmod -R 777 "$build_dir"

    # Run in Docker
    docker run --rm \
        --platform linux/amd64 \
        -v "$(pwd):/workspace" \
        -w /workspace \
        "$DOCKER_IMAGE" \
        bash -c "
            set -e

            # First, build Smith if not already built
            if [ ! -f /workspace/smith-install/lib/cmake/smith-config.cmake ]; then
                echo '==> Building Smith (this will take 15-30 minutes)...'
                cd /workspace/smith
                python3 ./config-build.py \
                    -hc host-configs/docker/llvm@19.1.1.cmake \
                    -bp /workspace/smith-build \
                    -ip /workspace/smith-install \
                    -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
                cd /workspace/smith-build
                make -j\$(nproc)
                make install
            fi

            echo '==> Configuring $model_name...'
            cd /workspace/$build_dir

            # Set MPI paths from the Docker environment
            export MPI_HOME=/home/serac/serac_tpls/llvm-19.1.1/mpich-4.2.0-bwz522ssj5775zpsjs2nxaj6gehd7tdq

            cmake ../smith-models/$model_name \
                -DSmith_DIR=/workspace/smith-install/lib/cmake \
                -DMPI_C_COMPILER=\${MPI_HOME}/bin/mpicc \
                -DMPI_CXX_COMPILER=\${MPI_HOME}/bin/mpicxx \
                -DMPIEXEC_EXECUTABLE=\${MPI_HOME}/bin/mpirun \
                -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

            echo ''
            echo '==> Building $model_name...'
            make -j\$(nproc)

            echo ''
            echo '==> Running $model_name...'
            ./$exec_name || true

            echo ''
        " || return 1

    echo -e "${GREEN}✓ Model '$model_name' completed${NC}"
    echo "Output files: $build_dir/"
    return 0
}

# Run a single model locally
run_model_local() {
    local model_name=$1
    local build_dir="build_${model_name}"
    local model_source="$MODELS_DIR/$model_name"
    local exec_name="${model_name//-/_}"

    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}Running model (Local): $model_name${NC}"
    echo -e "${BLUE}========================================${NC}"

    # Check if Smith is installed
    if [ ! -f "$SMITH_INSTALL/lib/cmake/smith-config.cmake" ]; then
        echo -e "${RED}Error: Smith is not installed locally${NC}"
        echo ""
        echo "Please either:"
        echo "  1. Run with --docker flag to use Docker"
        echo "  2. Build Smith locally first (see smith/README.md)"
        echo ""
        return 1
    fi

    # Create build directory
    mkdir -p "$build_dir"

    # Configure
    echo -e "${YELLOW}==> Configuring $model_name...${NC}"
    (cd "$build_dir" && cmake "$model_source" \
        -DSmith_DIR="$SMITH_INSTALL/lib/cmake" \
        -DCMAKE_EXPORT_COMPILE_COMMANDS=ON) || {
        echo -e "${RED}✗ Configuration failed${NC}"
        return 1
    }

    # Build
    echo ""
    echo -e "${YELLOW}==> Building $model_name...${NC}"
    (cd "$build_dir" && make -j$(sysctl -n hw.ncpu 2>/dev/null || echo 4)) || {
        echo -e "${RED}✗ Build failed${NC}"
        return 1
    }

    # Run
    echo ""
    echo -e "${YELLOW}==> Running $model_name...${NC}"
    (cd "$build_dir" && ./"$exec_name") || {
        echo -e "${YELLOW}Note: Model execution had issues (possibly expected for placeholder meshes)${NC}"
    }

    echo ""
    echo -e "${GREEN}✓ Model '$model_name' completed${NC}"
    echo "Output files: $build_dir/"
    return 0
}

# Run a single model
run_model() {
    local model_name=$1

    # Check if model exists
    if [ ! -d "$MODELS_DIR/$model_name" ]; then
        echo -e "${RED}Error: Model '$model_name' not found${NC}"
        echo "Available models: ${ALL_MODELS[*]}"
        return 1
    fi

    if should_use_docker; then
        run_model_docker "$model_name"
    else
        run_model_local "$model_name"
    fi
}

# Run all models
run_all_models() {
    local failed_models=()
    local successful_models=()

    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}Running all models${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""

    for model in "${ALL_MODELS[@]}"; do
        if run_model "$model"; then
            successful_models+=("$model")
        else
            failed_models+=("$model")
        fi
        echo ""
    done

    # Summary
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}Summary${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""
    echo -e "${GREEN}Successful (${#successful_models[@]}/${#ALL_MODELS[@]}):${NC}"
    for model in "${successful_models[@]}"; do
        echo -e "  ${GREEN}✓${NC} $model"
    done

    if [ ${#failed_models[@]} -gt 0 ]; then
        echo ""
        echo -e "${YELLOW}Completed with issues (${#failed_models[@]}/${#ALL_MODELS[@]}):${NC}"
        for model in "${failed_models[@]}"; do
            echo -e "  ${YELLOW}!${NC} $model"
        done
    fi

    return 0
}

# Clean build directories
clean_builds() {
    echo -e "${YELLOW}Cleaning all build directories...${NC}"
    rm -rf build_* smith-build smith-install
    echo -e "${GREEN}✓ Clean complete${NC}"
    echo ""
}

# Main script
main() {
    # Parse arguments
    RUN_ALL=false
    MODEL_NAME=""
    CLEAN=false

    while [[ $# -gt 0 ]]; do
        case $1 in
            --all)
                RUN_ALL=true
                shift
                ;;
            --list)
                list_models
                exit 0
                ;;
            --docker)
                USE_DOCKER="yes"
                shift
                ;;
            --local)
                USE_DOCKER="no"
                shift
                ;;
            --clean)
                CLEAN=true
                shift
                ;;
            -h|--help)
                usage
                exit 0
                ;;
            -*)
                echo -e "${RED}Error: Unknown option $1${NC}"
                usage
                exit 1
                ;;
            *)
                MODEL_NAME=$1
                shift
                ;;
        esac
    done

    # Clean if requested
    if [ "$CLEAN" = true ]; then
        clean_builds
    fi

    # Run models
    if [ "$RUN_ALL" = true ]; then
        run_all_models
    elif [ -n "$MODEL_NAME" ]; then
        run_model "$MODEL_NAME"
    else
        # Default: show usage
        usage
        exit 1
    fi
}

# Run main function
main "$@"
