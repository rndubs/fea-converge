#!/bin/bash
# Run Smith contact model from Puso & Laursen (2003) paper
# Reference: https://www.osti.gov/servlets/purl/15013715

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to display usage
usage() {
    echo "Usage: $0 <model_name>"
    echo ""
    echo "Available models:"
    echo "  die-on-slab          - Cylindrical die pressed and slid on flexible slab (Example 2)"
    echo "  block-on-slab        - Stiff square block pressed and slid on flexible slab (Example 2 variant)"
    echo "  sphere-in-sphere     - Solid sphere pressed into hollow sphere (Example 3)"
    echo ""
    echo "Example:"
    echo "  $0 die-on-slab"
    exit 1
}

# Check if argument is provided
if [ $# -eq 0 ]; then
    echo -e "${RED}Error: No model specified${NC}"
    usage
fi

MODEL_NAME=$1
MODEL_DIR="models/${MODEL_NAME}"
BUILD_DIR="build_${MODEL_NAME}"
PROJECT_ROOT="$(cd "$(dirname "$0")" && pwd)"

# Validate model name
if [ ! -d "$MODEL_DIR" ]; then
    echo -e "${RED}Error: Model '${MODEL_NAME}' not found${NC}"
    echo ""
    echo "Available models in 'models/' directory:"
    ls -d models/*/ 2>/dev/null | sed 's|models/||g' | sed 's|/||g' | sed 's/^/  /'
    exit 1
fi

echo -e "${GREEN}Running Smith model: ${MODEL_NAME}${NC}"
echo "Model directory: ${MODEL_DIR}"
echo ""

# Check if Smith has been built
SMITH_BUILD_DIR="${PROJECT_ROOT}/smith-build"
SMITH_INSTALL_DIR="${PROJECT_ROOT}/smith-install"

if [ ! -d "${SMITH_BUILD_DIR}" ] || [ ! -f "${SMITH_BUILD_DIR}/CMakeCache.txt" ]; then
    echo -e "${RED}Error: Smith has not been built yet${NC}"
    echo ""
    echo -e "${YELLOW}Please build Smith first using one of these methods:${NC}"
    echo ""
    echo -e "${BLUE}Option 1: Using Docker (recommended):${NC}"
    echo "  chmod +x build-smith-docker.sh"
    echo "  ./build-smith-docker.sh"
    echo ""
    echo -e "${BLUE}Option 2: Manual build with Docker:${NC}"
    echo "  ./docker-build-smith.sh"
    echo "  # Then inside the container:"
    echo "  cd /home/serac/serac"
    echo "  python3 ./config-build.py -hc host-configs/docker/llvm@19.1.1.cmake -bp /home/serac/smith-build -ip /home/serac/smith-install"
    echo "  cd /home/serac/smith-build"
    echo "  make -j\$(nproc)"
    echo "  make install"
    echo ""
    exit 1
fi

echo -e "${GREEN}✓ Smith build found at: ${SMITH_BUILD_DIR}${NC}"
echo ""

# Check for Smith install directory and smith-config.cmake
SMITH_DIR="${SMITH_INSTALL_DIR}"
if [ -f "${SMITH_INSTALL_DIR}/lib/cmake/smith-config.cmake" ]; then
    echo -e "${GREEN}✓ Smith installation found at: ${SMITH_INSTALL_DIR}${NC}"
    SMITH_DIR="${SMITH_INSTALL_DIR}/lib/cmake"
elif [ -f "${SMITH_INSTALL_DIR}/lib/cmake/smith/SmithConfig.cmake" ]; then
    echo -e "${GREEN}✓ Smith installation found at: ${SMITH_INSTALL_DIR}${NC}"
    SMITH_DIR="${SMITH_INSTALL_DIR}/lib/cmake/smith"
elif [ -f "${SMITH_BUILD_DIR}/smith-config.cmake" ]; then
    echo -e "${YELLOW}⚠ Using Smith build directory (not installed)${NC}"
    SMITH_DIR="${SMITH_BUILD_DIR}"
elif [ -f "${SMITH_BUILD_DIR}/SmithConfig.cmake" ]; then
    echo -e "${YELLOW}⚠ Using Smith build directory (not installed)${NC}"
    SMITH_DIR="${SMITH_BUILD_DIR}"
else
    echo -e "${RED}Error: Cannot find smith-config.cmake or SmithConfig.cmake${NC}"
    echo "Searched in:"
    echo "  ${SMITH_INSTALL_DIR}/lib/cmake/"
    echo "  ${SMITH_INSTALL_DIR}/lib/cmake/smith/"
    echo "  ${SMITH_BUILD_DIR}/"
    exit 1
fi

# Create build directory for the model
echo -e "${YELLOW}Creating build directory...${NC}"
mkdir -p "${BUILD_DIR}"
cd "${BUILD_DIR}"

# Configure with CMake
echo -e "${YELLOW}Configuring with CMake...${NC}"
cmake "../${MODEL_DIR}" \
    -DSmith_DIR="${SMITH_DIR}" \
    -DCMAKE_BUILD_TYPE=Release \
    -DSMITH_REPO_DIR="${PROJECT_ROOT}/smith"

# Build the model
echo -e "${YELLOW}Building model...${NC}"
make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)

# Find the executable (should match the model name with underscores)
EXECUTABLE=$(find . -maxdepth 1 -type f -executable -name "${MODEL_NAME//-/_}*" | head -n 1)

if [ -z "$EXECUTABLE" ]; then
    # Try without architecture suffix
    EXECUTABLE=$(find . -maxdepth 1 -type f -name "${MODEL_NAME//-/_}" | head -n 1)
fi

if [ -z "$EXECUTABLE" ]; then
    echo -e "${RED}Error: Executable not found after build${NC}"
    echo "Looking for: ${MODEL_NAME//-/_}"
    echo "Files in build directory:"
    ls -la
    exit 1
fi

# Run the model
echo ""
echo -e "${GREEN}Running ${MODEL_NAME}...${NC}"
echo ""

# Set library path if needed
if [ -d "${SMITH_INSTALL_DIR}/lib" ]; then
    export LD_LIBRARY_PATH="${SMITH_INSTALL_DIR}/lib:${LD_LIBRARY_PATH}"
    export DYLD_LIBRARY_PATH="${SMITH_INSTALL_DIR}/lib:${DYLD_LIBRARY_PATH}"
fi

${EXECUTABLE}

# Check if run was successful
if [ $? -eq 0 ]; then
    echo ""
    echo -e "${GREEN}✓ Model run completed successfully${NC}"
    echo ""
    echo "Output files location: $(pwd)"
    echo ""
    echo "To visualize results:"
    echo "  1. Open ParaView"
    echo "  2. Load: $(pwd)/${MODEL_NAME//-/_}_paraview.pvd"
else
    echo ""
    echo -e "${RED}✗ Model run failed${NC}"
    exit 1
fi
